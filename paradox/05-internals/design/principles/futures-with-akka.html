<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="docs">
<meta name="generator" content="Paradox, paradox-material-theme=0.4.0, mkdocs-material=2.2.2">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.language" content="">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="docs">
<link rel="shortcut icon" href="../../../cloud">
<title>Futures with Akka Â· Knora Documentation</title>
<link rel="stylesheet" href="../../../assets/stylesheets/application.7a4cdee3.css">
<link rel="stylesheet" href="../../../assets/stylesheets/application-palette.792431c1.css">
<link rel="stylesheet" href="../../../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../../../lib/prettify/prettify.css">
<script src="../../../lib/modernizr/modernizr.min.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="../../../assets/stylesheets/paradox-material-theme.css">
</head>
<body
data-md-color-primary="blue"
data-md-color-accent="yellow"
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
<label class="md-overlay" data-md-component="overlay" for="drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../../../index.html" title="Knora Documentation" class="md-header-nav__button md-logo">
<i class="md-icon">cloud</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
Knora Documentation
</span>
<span class="md-header-nav__topic">
Futures with Akka
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="search"></label>
<div class="md-search__inner">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" required placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
<label class="md-icon md-search__icon" for="search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/dhlab-basel/Knora/docs"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
dhlab-basel/Knora/docs
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<span class="md-nav__button md-logo">
<i class="md-icon">cloud</i>
</span>
<a href="../../../index.html" title="Knora Documentation">
Knora Documentation
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/dhlab-basel/Knora/docs"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
dhlab-basel/Knora/docs
</div>
</a>

</div>
<ul>
  <li><a href="../../../01-introduction/index.html" class="page">Introduction</a>
  <ul>
    <li><a href="../../../01-introduction/what-is-knora.html" class="page">What Is Knora?</a></li>
    <li><a href="../../../01-introduction/data-formats.html" class="page">Data Formats in Knora</a></li>
    <li><a href="../../../01-introduction/standoff-rdf.html" class="page">Standoff/RDF Text Markup</a></li>
    <li><a href="../../../01-introduction/example-project.html" class="page">An Example Project</a></li>
  </ul></li>
  <li><a href="../../../02-knora-ontologies/index.html" class="page">Knora Ontologies</a>
  <ul>
    <li><a href="../../../02-knora-ontologies/introduction.html" class="page">Introduction</a></li>
    <li><a href="../../../02-knora-ontologies/knora-base.html" class="page">The Knora Base Ontology</a></li>
    <li><a href="../../../02-knora-ontologies/salsah-gui.html" class="page">The SALSAH GUI Ontology</a></li>
  </ul></li>
  <li><a href="../../../03-apis/index.html" class="page">The Knora APIs</a>
  <ul>
    <li><a href="../../../03-apis/api-v1/index.html" class="page">Knora API v1</a></li>
    <li><a href="../../../03-apis/api-v2/index.html" class="page">Knora API v2</a></li>
    <li><a href="../../../03-apis/api-admin/index.html" class="page">Knora Admin API</a></li>
  </ul></li>
  <li><a href="../../../04-publishing-deployment/index.html" class="page">Deploying Knora</a>
  <ul>
    <li><a href="../../../04-publishing-deployment/publishing.html" class="page">Publishing</a></li>
    <li><a href="../../../04-publishing-deployment/getting-started.html" class="page">Getting Started with Knora</a></li>
    <li><a href="../../../04-publishing-deployment/configuration.html" class="page">Configuration</a></li>
    <li><a href="../../../04-publishing-deployment/updates.html" class="page">Updating Repositories When Upgrading Knora</a></li>
  </ul></li>
  <li><a href="../../../05-internals/index.html" class="page">Knora Internals</a>
  <ul>
    <li><a href="../../../05-internals/design/index.html" class="page">Design</a></li>
    <li><a href="../../../05-internals/development/index.html" class="page">Development</a></li>
  </ul></li>
  <li><a href="../../../06-salsah/index.html" class="page">The SALSAH 1 GUI</a></li>
  <li><a href="../../../07-sipi/index.html" class="page">The Sipi Media Server</a>
  <ul>
    <li><a href="../../../07-sipi/setup-sipi-for-knora.html" class="page">Setting Up Sipi for Knora</a></li>
    <li><a href="../../../07-sipi/sipi-and-knora.html" class="page">Interaction Between Sipi and Knora</a></li>
  </ul></li>
  <li><a href="../../../08-lucene/index.html" class="page">Lucene</a>
  <ul>
    <li><a href="../../../08-lucene/lucene-query-parser-syntax.html" class="page">Lucene Query Parser Syntax</a></li>
  </ul></li>
  <li><a href="../../../faq.html" class="page">Frequently Asked Questions</a></li>
  <li><a href="../../../00-release-notes/index.html" class="page">Release Notes</a>
  <ul>
    <li><a href="../../../00-release-notes/v1.1.0.html" class="page">v1.1.0 Release Notes</a></li>
    <li><a href="../../../00-release-notes/v1.2.0.html" class="page">v1.2.0 Release Notes</a></li>
    <li><a href="../../../00-release-notes/v1.3.0.html" class="page">v1.3.0 Release Notes</a></li>
    <li><a href="../../../00-release-notes/v1.4.0.html" class="page">v1.4.0 Release Notes</a></li>
    <li><a href="../../../00-release-notes/v1.5.0.html" class="page">v1.5.0 Release Notes</a></li>
    <li><a href="../../../00-release-notes/v1.6.0.html" class="page">v1.6.0 Release Notes</a></li>
    <li><a href="../../../00-release-notes/v1.7.0.html" class="page">v1.7.x Release Notes</a></li>
    <li><a href="../../../00-release-notes/v2.x.x.html" class="page">v2.x.x Release Notes</a></li>
    <li><a href="../../../00-release-notes/v3.x.x.html" class="page">v3.x.x Release Notes</a></li>
    <li><a href="../../../00-release-notes/v4.x.x.html" class="page">v4.x.x Release Notes</a></li>
    <li><a href="../../../00-release-notes/v5.x.x.html" class="page">v5.x.x Release Notes</a></li>
    <li><a href="../../../00-release-notes/v6.x.x.html" class="page">v6.x.x Release Notes</a></li>
    <li><a href="../../../00-release-notes/next.html" class="page">Release Notes for Next Release</a></li>
    <li><a href="../../../00-release-notes/migration.html" class="page">Migration Notes</a></li>
  </ul></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="toc">Table of contents</label>
<ul>
  <li><a href="../../../05-internals/design/principles/futures-with-akka.html#futures-with-akka" class="header">Futures with Akka</a>
  <ul>
    <li><a href="../../../05-internals/design/principles/futures-with-akka.html#introduction" class="header">Introduction</a></li>
    <li><a href="../../../05-internals/design/principles/futures-with-akka.html#handling-errors-with-futures" class="header">Handling Errors with Futures</a></li>
    <li><a href="../../../05-internals/design/principles/futures-with-akka.html#using-recover-on-futures" class="header">Using <code>recover</code> on Futures</a></li>
    <li><a href="../../../05-internals/design/principles/futures-with-akka.html#designing-with-futures" class="header">Designing with Futures</a></li>
    <li><a href="../../../05-internals/design/principles/futures-with-akka.html#mixing-futures-with-non-futures" class="header">Mixing Futures with non-Futures</a></li>
    <li><a href="../../../05-internals/design/principles/futures-with-akka.html#how-to-write-for-comprehensions" class="header">How to Write For-Comprehensions</a></li>
    <li><a href="../../../05-internals/design/principles/futures-with-akka.html#execution-contexts" class="header">Execution Contexts</a></li>
  </ul></li>
</ul>
</nav>

<div class="md-nav__title--site md-version" title="Version">
<i class="md-icon">label_outline</i> 9.1.0-55-ge7f47f6*
</div>
</nav>

</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="toc">Table of contents</label>
<ul>
  <li><a href="../../../05-internals/design/principles/futures-with-akka.html#futures-with-akka" class="header">Futures with Akka</a>
  <ul>
    <li><a href="../../../05-internals/design/principles/futures-with-akka.html#introduction" class="header">Introduction</a></li>
    <li><a href="../../../05-internals/design/principles/futures-with-akka.html#handling-errors-with-futures" class="header">Handling Errors with Futures</a></li>
    <li><a href="../../../05-internals/design/principles/futures-with-akka.html#using-recover-on-futures" class="header">Using <code>recover</code> on Futures</a></li>
    <li><a href="../../../05-internals/design/principles/futures-with-akka.html#designing-with-futures" class="header">Designing with Futures</a></li>
    <li><a href="../../../05-internals/design/principles/futures-with-akka.html#mixing-futures-with-non-futures" class="header">Mixing Futures with non-Futures</a></li>
    <li><a href="../../../05-internals/design/principles/futures-with-akka.html#how-to-write-for-comprehensions" class="header">How to Write For-Comprehensions</a></li>
    <li><a href="../../../05-internals/design/principles/futures-with-akka.html#execution-contexts" class="header">Execution Contexts</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<!---
Copyright Â© 2015-2019 the contributors (see Contributors.md).

This file is part of Knora.

Knora is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published
by the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

Knora is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public
License along with Knora.  If not, see <http://www.gnu.org/licenses/>.
-->
<h1><a href="#futures-with-akka" name="futures-with-akka" class="anchor"><span class="anchor-link"></span></a>Futures with Akka</h1>
<div class="toc ">
<ul>
  <li><a href="../../../05-internals/design/principles/futures-with-akka.html#introduction" class="header">Introduction</a></li>
  <li><a href="../../../05-internals/design/principles/futures-with-akka.html#handling-errors-with-futures" class="header">Handling Errors with Futures</a></li>
  <li><a href="../../../05-internals/design/principles/futures-with-akka.html#using-recover-on-futures" class="header">Using <code>recover</code> on Futures</a></li>
  <li><a href="../../../05-internals/design/principles/futures-with-akka.html#designing-with-futures" class="header">Designing with Futures</a></li>
  <li><a href="../../../05-internals/design/principles/futures-with-akka.html#mixing-futures-with-non-futures" class="header">Mixing Futures with non-Futures</a></li>
  <li><a href="../../../05-internals/design/principles/futures-with-akka.html#how-to-write-for-comprehensions" class="header">How to Write For-Comprehensions</a></li>
  <li><a href="../../../05-internals/design/principles/futures-with-akka.html#execution-contexts" class="header">Execution Contexts</a></li>
</ul>
</div>
<h2><a href="#introduction" name="introduction" class="anchor"><span class="anchor-link"></span></a>Introduction</h2>
<p><a href="http://docs.scala-lang.org/overviews/core/futures.html">Scala&rsquo;s documentation on futures</a> introduces them in this way:</p>
<blockquote>
  <p>Futures provide a nice way to reason about performing many operations in parallel â in an efficient and non-blocking way. The idea is simple, a Future is a sort of a placeholder object that you can create for a result that does not yet exist. Generally, the result of the Future is computed concurrently and can be later collected. Composing concurrent tasks in this way tends to result in faster, asynchronous, non-blocking parallel code.</p>
</blockquote>
<p>The rest of that page is well worth reading to get an overview of how futures work and what you can do with them.</p>
<p>In <a href="http://akka.io/">Akka</a>, one of the standard patterns for communication between actors is the <a href="https://doc.akka.io/docs/akka/current/actors.html?language=scala#ask-send-and-receive-future">ask pattern</a>, in which you send a message to an actor and you expect a reply. When you call the <code>ask</code> function (which can be written as a question mark, <code>?</code>, which acts as an infix operator), it immediately returns a <code>Future</code>, which will complete when the reply is sent. As the Akka documentation explains in <a href="https://doc.akka.io/docs/akka/snapshot/futures.html?language=scala#Use_With_Actors">Use with Actors</a>, it is possible to block the calling thread until the future completes, using <code>Await.result</code>. However, they say: &lsquo;Blocking is discouraged though as it will cause performance problems.&rsquo; In particular, by not blocking, you can do several <code>ask</code> requests in parallel.</p>
<p>One way to avoid blocking is to register a callback on the future, which will be called when it completes (perhaps by another thread), like this:</p>
<pre class="prettyprint"><code class="language-scala">future.onComplete {
    case Success(result) =&gt; println(result)
    case Failure(ex) =&gt; ex.printStackTrace()
}
</code></pre>
<p>But this won&rsquo;t work if you&rsquo;re writing a method that needs return a value based on the result of a future. In this case, you can register a callback that transforms the result of a future into another future:</p>
<pre class="prettyprint"><code class="language-scala">val newFuture = future.map(x =&gt; x + 1)
</code></pre>
<p>However, registering callbacks explicitly gets cumbersome when you need to work with several futures together. In this case, the most convenient alternative to blocking is to use <code>Future</code> as a monad. The links above explain what this means in detail, but the basic idea is that a special syntax, called a <code>for</code>-comprehension, allows you to write code that uses futures as if they were complete, without blocking. In reality, a <code>for</code>-comprehension is syntactic sugar for calling methods like <code>map</code>, but it&rsquo;s much easier to write and to read. You can do things like this:</p>
<pre class="prettyprint"><code class="language-scala">val fooFuture = (fooActor ? GetFoo(&quot;foo&quot;)).mapTo[Foo]
val barFuture = (barActor ? GetBar(&quot;bar&quot;)).mapTo[Bar]

val totalFuture = for {
    foo: Foo &lt;- fooFuture
    bar: Bar &lt;- barFuture

    total = foo.getCount + bar.getCount
} yield total
</code></pre>
<p>Here the messages to <code>fooActor</code> and <code>barActor</code> are sent and processed in parallel, but you&rsquo;re guaranteed that <code>total</code> won&rsquo;t be calculated until the values it needs are available. Note that if you construct <code>fooFuture</code> and <code>barFuture</code> inside the <code>for</code> comprehension, they won&rsquo;t be run in parallel (see <a href="http://buransky.com/scala/scala-for-comprehension-with-concurrently-running-futures/">Scala for-comprehension with concurrently running futures</a>).</p>
<h2><a href="#handling-errors-with-futures" name="handling-errors-with-futures" class="anchor"><span class="anchor-link"></span></a>Handling Errors with Futures</h2>
<p>The constructors and methods of <code>Future</code> (like those of <code>Try</code>) catch exceptions, which cause the future to fail. This very useful property of futures means that you usually don&rsquo;t need <code>try</code>-<code>catch</code> blocks when using the <code>Future</code> monad (although it is sometimes helpful to include them, in order to catch low-level exceptions and wrap them in higher-level ones). Any exception thrown in code that&rsquo;s being run asynchronously by <code>Future</code> (including in the <code>yield</code> expression of a <code>for</code> comprehension) will be caught, and the result will be a <code>Future</code> containing a <code>Failure</code>. Also, in the previous example, if <code>fooActor</code> or <code>barActor</code> returns a <code>Status.Failure</code> message, the <code>for</code>-comprehension will also yield a failed future.</p>
<p>However, you need to be careful with <em>the first line</em> of the <code>for</code>-comprehension. For example, this code doesn&rsquo;t handle exceptions correctly:</p>
<pre class="prettyprint"><code class="language-scala">private def doFooQuery(iri: IRI): Future[String] = {
    for {
        queryResponse &lt;- (storeManager ? SparqlSelectRequest(queries.sparql.v1.txt.getFoo(iri).toString())).mapTo[SparqlSelectResponse]
        ...
   } yield ...
}
</code></pre>
<p>The <code>getFoo()</code> method calls a <a href="https://github.com/playframework/twirl">Twirl</a> template function to generate SPARQL. The <code>?</code> operator returns a <code>Future</code>. However, the template function <em>is not run asynchronously</em>, because it is called before the <code>Future</code> constructor is called. So if the template function throws an exception, it won&rsquo;t be caught here. Instead, you can do this:</p>
<pre class="prettyprint"><code class="language-scala">private def doFooQuery(iri: IRI): Future[String] = {
    for {
        queryString &lt;- Future(queries.sparql.v1.txt.getFoo(iri).toString())
        queryResponse &lt;- (storeManager ? SparqlSelectRequest(queryString)).mapTo[SparqlSelectResponse]
        ...
   } yield ...
}
</code></pre>
<p>Here the <code>Future</code> constructor will call the template function asynchronously, and catch any exceptions it throws. This is only necessary if you need to call the template function at the <em>very beginning</em> of a <code>for</code>-comprehension. In the rest of the <code>for</code> comprehension, you&rsquo;ll already implicitly have a <code>Future</code> object.</p>
<h2><a href="#using-recover-on-futures" name="using-recover-on-futures" class="anchor"><span class="anchor-link"></span></a>Using <code>recover</code> on Futures</h2>
<p>By using <code>recover</code> on a Â <code>Future</code>, an apt error message can be thrown if the <code>Future</code> fails. This is particularly useful when an an error message should be made more clear depending on the context the <code>Future</code> is used in.</p>
<p>For example, we are asking the resources responder to query for a certain resource in order to process it in a special way. However, the client does not know that the resources responder is sent a request and in case the resource cannot be found, the message sent back from the resources responder (<code>NotFoundException</code>) would not make sense to it. Instead, we would like to handle the message in a way so that it makes sense for the operation the client actually executed. We can do this by calling <code>recover</code> on a <code>Future</code>.</p>
<pre class="prettyprint"><code class="language-scala">private def mySpecialResourceRequest(iri: IRI, userProfile: UserProfileV1): Future[...] = {

    val resourceRequestFuture = for {
        resResponse: ResourceFullResponseV1 &lt;- (responderManager ? ResourceFullGetRequestV1(iri = iri, userProfile = userProfile, getIncoming = false)).mapTo[ResourceFullResponseV1]
    } yield resResponse

    val resourceRequestFutureRecovered = resourceRequestFuture.recover {
        case notFound: NotFoundException =&gt; throw BadRequestException(s&quot;Special resource handling failed because the resource could not be found: ${notFound.message}&quot;)
    }

    for {

        res &lt;- resourceRequestFutureRecovered

        ...

    } yield ...

}   
</code></pre>
<p>Please note that the content of the <code>Future</code> has to be accessed using <code>&lt;-</code> to make this work correctly. Otherwise the content will never be looked at.</p>
<h2><a href="#designing-with-futures" name="designing-with-futures" class="anchor"><span class="anchor-link"></span></a>Designing with Futures</h2>
<p>In the current design, Knora almost never blocks to wait for a future to complete. The normal flow of control works like this:</p>
<ol>
  <li>Incoming HTTP requests are handled by an actor called <code>KnoraService</code>, which delegates them to routing functions (in the <code>routing</code> package).</li>
  <li>For each request, a routing function gets an Akka HTTP <code>RequestContext</code>, and calls <code>RouteUtilV1.runJsonRoute</code> (in API v1) or <code>RouteUtilV2.runRdfRouteWithFuture</code> (in API v2) to send a message to a supervisor actor to fulfil the request. This creates a <code>Future</code> that will complete when the relevant responder sends its reply. The routing utility registers a callback on this <code>Future</code> to handle the reply message when it becomes available.</li>
  <li>The supervisor forwards the message to be handled by the appropriate responder.</li>
  <li>The responder&rsquo;s <code>receive</code> method receives the message, and calls some private method that produces a reply message inside a <code>Future</code>. This may involve sending messages to other actors using <code>ask</code>, getting futures back, and combining them into a single future containing the reply message.</li>
  <li>The responder passes that future to <code>ActorUtils.future2Message</code>, which registers a callback on it. When the future completes (perhaps in another thread), the callback sends the reply message. In the meantime, the responder doesn&rsquo;t block, so it can start handling the next request.</li>
  <li>When the responder&rsquo;s reply becomes available, the routing utility&rsquo;s callback registered in (2) calls <code>complete</code> on the <code>RequestContext</code>, which sends an HTTP response to the client.</li>
</ol>
<p>The basic rule of thumb is this: if you&rsquo;re writing a method in an actor, and anything in the method needs to come from a future (e.g. because you need to use <code>ask</code> to get some information from another actor), have the method return a future.</p>
<h2><a href="#mixing-futures-with-non-futures" name="mixing-futures-with-non-futures" class="anchor"><span class="anchor-link"></span></a>Mixing Futures with non-Futures</h2>
<p>If you have a <code>match ... case</code> or <code>if</code> expression, and one branch obtains some data in a future, but another branch can produce the data immediately, you can wrap the result of the latter branch in a future, so that both branches have the same type. Here we use an alternative implementation of <code>scala.concurrent.Future</code>, found in <code>akka.http.scaladsl.util.FastFuture</code>, which tries to avoid scheduling to an <code>scala.concurrent.ExecutionContext</code> if possible, i.e. if the given future value is already present:</p>
<pre class="prettyprint"><code class="language-scala">def getTotalOfFooAndBar(howToGetFoo: String): Future[Int] = {
    for {
        foo &lt;- howToGetFoo match {
            case &quot;askForIt&quot; =&gt; (fooActor ? GetFoo(&quot;foo&quot;)).mapTo[Foo]
            case &quot;createIt&quot; =&gt; FastFuture.successful(new Foo())
        }

        bar &lt;- (barActor ? GetBar(&quot;bar&quot;)).mapTo[Bar]

        total = foo.getCount + bar.getCount
    } yield total
}
</code></pre>
<h2><a href="#how-to-write-for-comprehensions" name="how-to-write-for-comprehensions" class="anchor"><span class="anchor-link"></span></a>How to Write For-Comprehensions</h2>
<p>Here are some basic rules for writing <code>for</code>-comprehensions:</p>
<ol>
  <li>The first line of a <code>for</code>-comprehension has to be a &ldquo;generator&rdquo;, i.e. it has to use the <code>&lt;-</code> operator. If you want to write an assignment (using <code>=</code>) as the first line, the workaround is to wrap the right-hand side in a monad (like <code>Future</code>) and use <code>&lt;-</code> instead.</li>
  <li>Assignments (using <code>=</code>) are written without <code>val</code>.</li>
  <li>You&rsquo;re not allowed to write statements that throw away their return values, so if you want to call something like <code>println</code> that returns <code>Unit</code>, you have to assign its return value to <code>_</code>.</li>
</ol>
<p>The <code>yield</code> returns an object of the same type as the generators, which all have to produce the same type (e.g. <code>Future</code>).</p>
<h2><a href="#execution-contexts" name="execution-contexts" class="anchor"><span class="anchor-link"></span></a>Execution Contexts</h2>
<p>Whenever you use a future, there has to be an implicit &lsquo;execution context&rsquo; in scope. <a href="http://docs.scala-lang.org/overviews/core/futures.html">Scala&rsquo;s documentation on futures</a> says, &lsquo;you can think of execution contexts as thread pools&rsquo;.</p>
<p>If you don&rsquo;t have an execution context in scope, you&rsquo;ll get a compile error asking you to include one, and suggesting that you could use <code>import scala.concurrent.ExecutionContext.Implicits.global</code>. Don&rsquo;t do this, because the global Scala execution context is not the most efficient option. Instead, use Knora&rsquo;s custom execution context like so:</p>
<pre class="prettyprint"><code class="language-scala">implicit val executionContext: ExecutionContext = system.dispatchers.lookup(KnoraDispatchers.KnoraActorDispatcher)
</code></pre>
</div>
<div>
<a href="https://github.com/dhlab-basel/Knora/tree/master/docs/src/paradox/05-internals/design/principles/futures-with-akka.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
9.1.0-55-ge7f47f6*
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../../../05-internals/design/principles/design-overview.html" title="Knora API Server Design Overview" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Knora API Server Design Overview
</span>
</div>
</a>
<a href="../../../05-internals/design/principles/http-module.html" title="HTTP Module" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
HTTP Module
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
<div class="md-footer-copyright__highlight">
Copyright 2015-2019 the contributors (see Contributors.md)
</div>
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
<div class="md-footer-social">
<a href="https://github.com/dhlab-basel" class="md-footer-social__link fa fa-github"></a><a href="https://twitter.com/dhlabbasel" class="md-footer-social__link fa fa-twitter"></a>
</div>

</div>
</div>
</footer>

</div>
<script src="../../../assets/javascripts/application.5165553b.js"></script>
<script src="../../../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../../../."}})</script>
<script type="text/javascript" src="../../../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../../../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
